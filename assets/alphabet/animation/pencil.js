// This file is generated by the script: svgator_videos_to_js_dict.py
/* eslint-disable react-hooks/exhaustive-deps */
// @ts-nocheck
import SVGatorPlayer from "@svgator/react-native";
import React, {
  forwardRef,
  useEffect,
  useImperativeHandle,
  useRef,
  useState,
} from "react";
import WebView from "react-native-webview";

import pencilMap from "./pencil-map";

const Pencil = forwardRef(({ onAnimationComplete, letter, ...props }, ref) => {
  const webViewRef = useRef(null);
  const [isWebViewReady, setIsWebViewReady] = useState(false);

  const svgContent = pencilMap[letter] || "<svg></svg>"; // Default to empty SVG if letter not found
  const wrappedHtml = SVGatorPlayer.wrapPage(svgContent);

  const injectJavaScript = (code) => {
    if (isWebViewReady) {
      webViewRef.current?.injectJavaScript(`
          (function() {
            try {
              ${code}
            } catch (error) {
              console.error('Error in injected JavaScript:', error);
            }
          })();
          true;
        `);
    } else {
      console.warn("WebView is not ready. Skipping JavaScript injection.");
    }
  };

  useImperativeHandle(ref, () => ({
    play: () => {
      console.log("Play method called");
      injectJavaScript(`
          console.log('Attempting to find SVG element');
          const svg = document.querySelector('svg');
          if (!svg) {
            console.error('SVG element not found');
            return;
          }
          console.log('SVG element found, checking for svgatorPlayer');
          if (!svg.svgatorPlayer) {
            console.error('svgatorPlayer not found on SVG element');
            return;
          }
          console.log('svgatorPlayer found, calling play method');
          svg.svgatorPlayer.play();
        `);
    },
  }));

  const onMessage = (event) => {
    console.log("Message received:", event.nativeEvent.data);
    try {
      const data = JSON.parse(event.nativeEvent.data);
      if (data.event === "animationComplete") {
        console.log("Animation complete event received");
        onAnimationComplete && onAnimationComplete();
      }
    } catch (error) {
      console.error("Error parsing message:", error);
    }
  };

  useEffect(() => {
    if (isWebViewReady) {
      console.log("WebView is ready, setting up animation");
      injectJavaScript(`
          console.log('Setup code running');
          const svg = document.querySelector('svg');
          if (!svg) {
            console.error('SVG element not found during setup');
            return;
          }
          if (!svg.svgatorPlayer) {
            console.error('svgatorPlayer not found on SVG element during setup');
            return;
          }
          console.log('Setting up animation listeners');
          svg.svgatorPlayer.on('end', function() {
            console.log('Animation ended, sending message');
            window.ReactNativeWebView.postMessage(JSON.stringify({ event: 'animationComplete' }));
          });
        `);
    }
  }, [isWebViewReady]);

  const { newProps, styles } = SVGatorPlayer.getWebViewProps(
    props,
    wrappedHtml,
  );

  return (
    <WebView
      ref={webViewRef}
      {...newProps}
      source={{ html: wrappedHtml }}
      containerStyle={styles.container}
      style={styles.style}
      onMessage={onMessage}
      onError={(syntheticEvent) => {
        const { nativeEvent } = syntheticEvent;
        console.error("WebView error: ", nativeEvent);
      }}
      onHttpError={(syntheticEvent) => {
        const { nativeEvent } = syntheticEvent;
        console.error("WebView HTTP error: ", nativeEvent);
      }}
      onLoadEnd={() => {
        console.log("WebView content loaded");
        setIsWebViewReady(true);
      }}
      injectedJavaScript={`
          window.addEventListener('load', function() {
            window.ReactNativeWebView.postMessage(JSON.stringify({ event: 'windowLoaded' }));
          });
          true;
        `}
    />
  );
});

export default Pencil;
